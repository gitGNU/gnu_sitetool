#!/bin/sh

#BASEDIR=utils

#. $BASEDIR/environment.sh || exit 1

PROGNAME=bootstrap

#
# Dump some useful informations
#
echo "$PROGNAME: Dumping build-tools information ..."
for tool in autoheader autoconf libtool libtoolize aclocal automake; do
    TOOLVER=`$tool --version | head -1`
    echo "$PROGNAME:   $TOOLVER"
done

#
# configure.ac
#
echo "$PROGNAME: Building configure.ac from configure.ac.in"
#if test ! -r ChangeLog ; then
#    echo "$PROGNAME: Cannot read ChangeLog file"
#    exit 1
#fi
#head -n 1 ChangeLog | sed -e 's/:.*//' > VERSION || {
#    echo "$PROGNAME: Cannot build VERSION file"
#    rm -f VERSION
#    exit 1
#}
rm -f configure.ac
VERSION=`git tag -l | tail -n 1`
cat configure.ac.in | sed -e 's,[@]VERSION[@],'$VERSION',' > configure.ac || \
{ rm -f configure.ac ; exit 1 ; }
chmod a-w configure.ac

#
# autoreconf
#
echo "$PROGNAME: Handling autotools bootstrap ..."

echo "$PROGNAME: Removing aclocal.m4 ..."
rm -f aclocal.m4 || exit 1

echo "$PROGNAME: Running autoreconf ..."
autoreconf --verbose --force --install -Wall || {
    echo "$PROGNAME: Cannot find autoreconf ..."
    exit 1
}

exit 0
